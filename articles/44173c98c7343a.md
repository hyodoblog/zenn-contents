---
title: "Stripe Connectå†…ã®å­ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ˜ç´°ã‚’å–å¾—ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ¦"
type: "tech"
topics:
  - "stripe"
  - "stripeconnect"
  - "balance"
published: true
published_at: "2022-06-14 19:04"
---

ç¾åœ¨é‹ç”¨ä¸­ã®Stripe Connectã‚’ä½¿ã£ãŸã‚µãƒ¼ãƒ“ã‚¹ã§ã€å­ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ˆã‚Šã€Œå…¥é‡‘ã®æ˜ç´°ãŒã»ã—ã„ã€ã¨è¨€ã‚ã‚ŒãŸãŸã‚ã€ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹ãŸã‚ã«Stripe APIã‚’è‰²ã€…è§¦ã£ãŸçŸ¥è¦‹ã‚’ãƒ¡ãƒ¢ã—ã¾ã™ã€‚


# balanceTransactions API

èª¿æŸ»ã—ãŸçµæœã€`balanceTransactions`ã‚’ä½¿ã†ã®ãŒå¦¥å½“ã ã¨åˆ¤æ–­ã—ã¾ã—ãŸã€‚

## ä½¿ã„æ–¹

```typescript
interface BalanceData {
  created: number
  fee: number
  net: number
  amount: number
}

const balanceAscSortByCreated = (a: BalanceData, b: BalanceData): number => {
  if (a.created > b.created) return 1
  else if (a.created < b.created) return -1
  return 0
}

export const getBalances = async (
  { year: number; month: number },
  stripeAccount: string,
  limit = 100
): Promise<BalanceData[]> => {
  // ãŠå¥½ãã«validationã—ã¦ãã ã•ã„ã€‚
  if (year < 2021 || year > 2050) throw Error('year invalid.')
  else if (month < 1 || month > 12) throw Error('month invalid.')

  const startTime =
    moment(`${year}-${('00' + String(month)).slice(-2)}-01 00:00`)
      .startOf('M')
      .toDate()
      .getTime() / 1000
  const endTime =
    moment(`${year}-${('00' + String(month)).slice(-2)}-01 00:00`)
      .endOf('M')
      .toDate()
      .getTime() / 1000

  const balances: BalanceData[] = []
  let lastBalanceId: string | undefined

  do {
    //
    const { data: balanceList } = await stripe.balanceTransactions.list(
      { limit, starting_after: lastBalanceId },
      { stripeAccount }
    )

    // sort.
    balanceList.sort(balanceAscSortByCreated)

    // add validation.
    if (balanceList.length === 0) break

    // add.
    balanceList.forEach((balanceData) => {
      if (balanceData.created > startTime && balanceData.created < endTime) {
        balances.push({
          created: balanceData.created * 1000,
          amount: balanceData.amount,
          net: balanceData.net,
          fee: balanceData.fee
        })
      }
    })

    // loop validation.
    const isBeforeMonth = balanceList[0].created < startTime
    if (balanceList.length < limit || !isBeforeMonth) {
      lastBalanceId = balanceList[0].id
    } else {
      lastBalanceId = undefined
    }
  } while (lastBalanceId)

  // sort created.
  balances.sort(balanceAscSortByCreated)

  return balances
}
```

`getBalances`é–¢æ•°ã®å¼•æ•°ã«ã€`year`ã€`month`ã€`stripeAccountId`ã‚’æ¸¡ã™ã“ã¨ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æç”»ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## å‡ºåŠ›å†…å®¹

![](https://storage.googleapis.com/zenn-user-upload/76c62c7f64ff-20220614.gif)

ã¨ã‚Šã‚ãˆãšTableè¡¨ç¤ºã—ãŸã ã‘ãªã®ã§ã€ä»Šå¾ŒãŠé‡‘ã®å¤‰å‹•ã‚°ãƒ©ãƒ•ã‚’ä½œã‚Šã‚ˆã‚Šè¦‹ã‚„ã™ãã™ã‚‹äºˆå®šã§ã™ã€‚


# è±†çŸ¥è­˜

Stripe APIã®èª¿æŸ»ã™ã‚‹éš›ã¯ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚ˆã‚Šã‚‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã®ä¸­ã‚’è¦‹ã‚‹ã“ã¨ã‚’ã‚ªã‚¹ã‚¹ãƒ¡ã—ã¾ã™ã€‚
Stripe SDKã¯ã€éå¸¸ã«ã‚³ãƒ¼ãƒ‰ãŒèª­ã¿ã‚„ã™ãã€ã‚³ãƒ¡ãƒ³ãƒˆãŒå……å®Ÿã—ã¦ã¾ã™ã€‚
ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ãƒœãƒªãƒ¥ãƒ¼ãƒ ãŒå¤šãæ¢ã™ã®ãŒå¤§å¤‰ã§ã™ãŒã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã ã¨VSCodeã®æ¤œç´¢æ©Ÿèƒ½ã‚„è£œå®Œã«ã‚ˆã£ã¦ã€æ±‚ã‚ã¦ã„ãŸAPIã‚’æ¢ã™ã®ãŒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚ˆã‚ŠåŠ¹ç‡ãŒã‚ˆã„æ™‚ãŒå¤šã€…ã‚ã‚Šã¾ã—ãŸã€‚


ä»¥ä¸Šã€